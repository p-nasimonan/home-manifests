# Wrapper Chart用 values.yaml
# 親チャートから子チャート(minecraft)を設定する形式

minecraft:
  image:
    repository: itzg/minecraft-server
    tag: latest
    pullPolicy: Always

  # ---------------------------------------------------------
  # リソースとメモリ設定
  # ---------------------------------------------------------
  resources:
    requests:
      memory: 4Gi
      cpu: 1000m
    limits:
      memory: 16Gi
      cpu: 4000m

  # ---------------------------------------------------------
  # サーバー設定本体
  # ---------------------------------------------------------
  minecraftServer:
    eula: "TRUE"
    version: "1.20.6"
    type: "PAPER"
    difficulty: "normal"
    motd: "Welcome to My Home K3s Server"
    
    # メモリ設定 (コンテナ制限16Giに対して余裕を持たせる)
    memory: 14G
    
    maxPlayers: 20
    allowNether: true
    enableCommandBlock: true
    generateStructures: true
    hardcore: false
    spawnAnimals: true
    spawnMonsters: true
    spawnNPCs: true
    viewDistance: 10
    gameMode: survival
    
    ops: "Youkan0124"
    
    # JVM最適化
    jvmOpts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled"

    # -------------------------------------------------------
    # Service設定 (接続安定化)
    # -------------------------------------------------------
    serviceType: LoadBalancer
    servicePort: 25565
    loadBalancerIP: "192.168.0.220"
    
    # ★重要: これをLocalにしないと接続が切れます
    externalTrafficPolicy: Local

    # -------------------------------------------------------
    # プラグイン設定
    # -------------------------------------------------------
    spigetResources:
      - 52867   # WarpGUI
      - 90741   # PingCheck
      - 44497   # BossBar Message
      - 96927   # DecentHolograms
      - 101066  # Death Chest
      - 8695    # AdvancedBan
    
    pluginUrls:
      - https://github.com/ViaVersion/ViaVersion/releases/download/5.7.0/ViaVersion-5.7.0.jar
      - https://github.com/ViaVersion/ViaBackwards/releases/download/5.7.0/ViaBackwards-5.7.0.jar
      - https://github.com/ViaVersion/ViaRewind/releases/download/4.0.13/ViaRewind-4.0.13.jar
      - https://github.com/kernitus/BukkitOldCombatMechanics/releases/download/v2.2.0/OldCombatMechanics-v2.2.0.jar
      - https://www.curseforge.com/api/v1/mods/31620/files/6769644/download

  # ---------------------------------------------------------
  # 環境変数（接続切れ・MTU対策）
  # ---------------------------------------------------------
  extraEnv:
    # 圧縮を無効化
    NETWORK_COMPRESSION_THRESHOLD: "-1"
    # タイムアウト延長
    PLAYER_IDLE_TIMEOUT: "600"
    # MTU問題対策 (IPv4優先)
    JVM_XX_OPTS: "-Djava.net.preferIPv4Stack=true"

  # ---------------------------------------------------------
  # 追加ポート（Dynmap用）
  # ---------------------------------------------------------
  extraPorts:
    - name: dynmap
      containerPort: 8123
      protocol: TCP
      service:
        enabled: true
        type: ClusterIP
        port: 8123
      ingress:
        enabled: true
        ingressClassName: cloudflare
        hosts:
          - name: dynmap.youkan.uk
            path: /

  # ---------------------------------------------------------
  # ストレージ設定 (NFS)
  # ---------------------------------------------------------
  persistence:
    dataDir:
      enabled: true
      Size: 20Gi
      storageClassName: "nfs-client"
      accessModes:
        - ReadWriteOnce
      # existingClaim は削除しました（自動生成させます）

  # ---------------------------------------------------------
  # ヘルスチェック（起動待機設定）
  # ---------------------------------------------------------
  startupProbe:
    enabled: true
    command:
      - mc-health
    failureThreshold: 30
    periodSeconds: 10

  livenessProbe:
    command:
      - mc-health
    initialDelaySeconds: 5
    periodSeconds: 10
    failureThreshold: 3
    successThreshold: 1
    timeoutSeconds: 5

  readinessProbe:
    command:
      - mc-health
    initialDelaySeconds: 5
    periodSeconds: 10
    failureThreshold: 3
    successThreshold: 1
    timeoutSeconds: 5