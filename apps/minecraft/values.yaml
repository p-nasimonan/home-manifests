# Minecraft サーバー設定
# itzg/minecraft-server Helm Chart 用の values.yaml
# ラッパーチャート形式: 依存チャート名で階層化

minecraft:
  image:
    repository: itzg/minecraft-server
    tag: java21
    pullPolicy: Always

  replicaCount: 1

  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 3000
    runAsNonRoot: true
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

  nodeSelector: {}

  tolerations: []

  affinity: {}

  minecraftServer:
    eula: "TRUE"
    version: "1.20.6"
    type: "PAPER"  # 軽量サーバー（VANILLA より推奨）
    difficulty: "normal"
    levelType: "minecraft:normal"
    motd: "ようかんのサーバーへようこそー"
    memory: 14G    # メモリ割り当て（16GiB制限内で余裕を持たせる）
    maxPlayers: 20
    allowNether: true
    enableCommandBlock: true
    generateStructures: true
    hardcore: false
    spawnAnimals: true
    spawnMonsters: true
    spawnNPCs: true
    viewDistance: 10
    gameMode: survival
    
    # OP権限を付与するユーザー
    ops: Youkan0124
    
    # Service 設定（itzg チャート v5.0.0 形式）
    serviceType: LoadBalancer
    servicePort: 25565
    loadBalancerIP: 192.168.0.220
    
    # JVM最適化
    jvmOpts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled"
    
    # Spigot プラグイン（Spigot リソース ID で自動ダウンロード）
    spigetResources:
      - 52867   # WarpGUI
      - 90741   # PingCheck
      - 96927   # DecentHolograms
      - 101066  # Death Chest
      - 8695    # AdvancedBan
      - 81254
    
    # 直接 URL でダウンロードするプラグイン（GitHub リリース）
    pluginUrls:
      - https://github.com/dmulloy2/ProtocolLib/releases/download/dev-build/ProtocolLib.jar # protcollib
      - https://github.com/ViaVersion/ViaVersion/releases/download/5.7.0/ViaVersion-5.7.0.jar  # ViaVersion
      - https://github.com/ViaVersion/ViaBackwards/releases/download/5.7.0/ViaBackwards-5.7.0.jar  # ViaBackwards
      - https://github.com/ViaVersion/ViaRewind/releases/download/4.0.13/ViaRewind-4.0.13.jar  # ViaRewind
      - https://github.com/kernitus/BukkitOldCombatMechanics/releases/download/v2.2.0/OldCombatMechanics-v2.2.0.jar  # OldCombatMechanics
      - https://www.curseforge.com/api/v1/mods/31620/files/6769644/download  # Dynmap
    
    # Dynmap 用のポート公開設定
    extraPorts:
      - name: dynmap
        containerPort: 8123
        protocol: TCP
        service:
          enabled: true
          embedded: false
          type: ClusterIP  # Cloudflare Tunnel 経由なので ClusterIP で OK
          port: 8123
        ingress:
          enabled: true
          ingressClassName: cloudflare
          hosts:
            - name: dynmap.youkan.uk
              path: /
  
  ## Additional minecraft container environment variables
  ## Values can be either variable values or `valueFrom` yaml
  extraEnv:
    # ネットワーク最適化（接続安定性向上）
    NETWORK_COMPRESSION_THRESHOLD: "-1"  # 圧縮を完全に無効化
    PLAYER_IDLE_TIMEOUT: "600"  # タイムアウトを10分に延長
    JVM_XX_OPTS: "-Djava.net.preferIPv4Stack=true"  # IPv4優先化でパケットトラブル低減

  persistence:
    dataDir:
      enabled: true
      Size: 20Gi
      storageClassName: nfs-client
  
  resources:
    requests:
      memory: 4Gi
      cpu: 1000m
    limits:
      memory: 16Gi
      cpu: 4000m
  
  # ConfigMapのボリューム設定（MiniMOTD用外部設定ファイル）
  extraVolumes:
    - name: minimotd-config-vol
      configMap:
        name: minimotd-external-config
        items:
          - key: main.conf
            path: main.conf
  
  # ConfigMapのマウント設定
  extraVolumeMounts:
    - name: minimotd-config-vol
      mountPath: /data/plugins/MiniMOTD/
      readOnly: true
  
  # ヘルスチェック設定（Java起動遅延を許す設定）
  livenessProbe:
    command:
      - mc-health
    initialDelaySeconds: 60   # 最初の60秒はチェックしない
    periodSeconds: 10         # 10秒ごとにチェック
    failureThreshold: 30      # 30回失敗まで許す（＝300秒待機）
    timeoutSeconds: 5         # 返答待ち時間を5秒に延長
    successThreshold: 1
    
  readinessProbe:
    command:
      - mc-health
    initialDelaySeconds: 60
    periodSeconds: 10
    failureThreshold: 30
    timeoutSeconds: 5
    successThreshold: 1

  startupProbe:
    command:
      - mc-health
    enabled: false
    failureThreshold: 30
    periodSeconds: 10
