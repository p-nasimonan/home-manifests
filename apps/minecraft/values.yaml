# Minecraft サーバー設定
# itzg/minecraft-server Helm Chart 用の values.yaml
# ラッパーチャート形式: 依存チャート名で階層化
minecraft:
  image:
    repository: itzg/minecraft-server
    tag: latest
    pullPolicy: Always

  replicaCount: 1

  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 3000
    runAsNonRoot: true
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

  nodeSelector: {}

  tolerations: []

  affinity: {}

  minecraftServer:
    eula: "TRUE"
    version: "1.20.6"
    type: "PAPER"
    difficulty: "normal"
    motd: "ようかんのサーバーへようこそー"
    memory: 14G
    maxPlayers: 20
    allowNether: true
    enableCommandBlock: true
    generateStructures: true
    hardcore: false
    spawnAnimals: true
    spawnMonsters: true
    spawnNPCs: true
    viewDistance: 10
    gameMode: survival
    
    # OP権限を付与するユーザー
    ops: Youkan0124
    
    # Service 設定
    serviceType: LoadBalancer
    servicePort: 25565
    loadBalancerIP: 192.168.0.220
    
    externalTrafficPolicy: Local
    
    # JVM最適化
    jvmOpts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled"
    
    # Spigot プラグイン
    spigetResources:
      - 52867   # WarpGUI
      - 90741   # PingCheck
      - 44497   # BossBar Message
      - 96927   # DecentHolograms
      - 101066  # Death Chest
      - 8695    # AdvancedBan
    
    # 直接 URL でダウンロードするプラグイン
    pluginUrls:
      - https://github.com/ViaVersion/ViaVersion/releases/download/5.7.0/ViaVersion-5.7.0.jar
      - https://github.com/ViaVersion/ViaBackwards/releases/download/5.7.0/ViaBackwards-5.7.0.jar
      - https://github.com/ViaVersion/ViaRewind/releases/download/4.0.13/ViaRewind-4.0.13.jar
      - https://github.com/kernitus/BukkitOldCombatMechanics/releases/download/v2.2.0/OldCombatMechanics-v2.2.0.jar
      - https://www.curseforge.com/api/v1/mods/31620/files/6769644/download
    
    # Dynmap 用のポート公開設定
    extraPorts:
      - name: dynmap
        containerPort: 8123
        protocol: TCP
        service:
          enabled: true
          embedded: false
          type: ClusterIP
          port: 8123
        ingress:
          enabled: true
          ingressClassName: cloudflare
          hosts:
            - name: dynmap.youkan.uk
              path: /
  
  ## 環境変数
  extraEnv:
    # ネットワーク最適化
    NETWORK_COMPRESSION_THRESHOLD: "-1"
    PLAYER_IDLE_TIMEOUT: "600"
    JVM_XX_OPTS: "-Djava.net.preferIPv4Stack=true"

  persistence:
    dataDir:
      enabled: true
      size: 20Gi
      storageClassName: nfs-client
  
  resources:
    requests:
      memory: 4Gi
      cpu: 1000m
    limits:
      memory: 16Gi
      cpu: 4000m
  
  # ヘルスチェック設定
  livenessProbe:
    command:
      - mc-health
    initialDelaySeconds: 60
    periodSeconds: 10
    failureThreshold: 30
    timeoutSeconds: 5
    successThreshold: 1
    
  readinessProbe:
    command:
      - mc-health
    initialDelaySeconds: 60
    periodSeconds: 10
    failureThreshold: 30
    timeoutSeconds: 5
    successThreshold: 1

  startupProbe:
    command:
      - mc-health
    enabled: true 
    failureThreshold: 30
    periodSeconds: 10