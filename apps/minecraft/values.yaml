# Minecraft サーバー設定
# itzg/minecraft-server Helm Chart 用の values.yaml

minecraft:
  image:
    repository: itzg/minecraft-server
    tag: java21
    pullPolicy: Always

  replicaCount: 1

  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 3000
    runAsNonRoot: true
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

  # サーバー設定
  minecraftServer:
    eula: "TRUE"
    version: "1.20.6"
    type: "PAPER"
    difficulty: "normal"
    levelType: "minecraft:normal"
    motd: "ようかんのサーバーへようこそー"
    # サーバーアイコン (URLから自動取得)
    icon: "https://s3.youkan.uk/misskey/1b56dc5e-710e-4321-9f62-06e6c6d13f48.png"
    
    memory: 14G
    maxPlayers: 20
    allowNether: true
    enableCommandBlock: true
    generateStructures: true
    hardcore: false
    spawnAnimals: true
    spawnMonsters: true
    spawnNPCs: true
    viewDistance: 10
    gameMode: survival
    
    # OP権限を付与するユーザー
    ops: Youkan0124
    
    # サービス設定
    serviceType: LoadBalancer
    servicePort: 25565
    loadBalancerIP: 192.168.0.220
    
    jvmOpts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled"
    
    spigetResources:
      - 90741   # PingCheck
      - 96927   # DecentHolograms
      - 101066  # Death Chest
      - 8695    # AdvancedBan
    
    pluginUrls:
      - https://cdn.modrinth.com/data/16vhQOQN/versions/mwkVZ6FJ/minimotd-bukkit-2.2.2.jar #なんかmotdカラフルにできるやつ
      - https://github.com/dmulloy2/ProtocolLib/releases/download/dev-build/ProtocolLib.jar # protcollib
      - https://github.com/ViaVersion/ViaVersion/releases/download/5.7.0/ViaVersion-5.7.0.jar  # ViaVersion
      - https://github.com/ViaVersion/ViaBackwards/releases/download/5.7.0/ViaBackwards-5.7.0.jar  # ViaBackwards
      - https://github.com/ViaVersion/ViaRewind/releases/download/4.0.13/ViaRewind-4.0.13.jar  # ViaRewind
      - https://github.com/kernitus/BukkitOldCombatMechanics/releases/download/v2.2.0/OldCombatMechanics-v2.2.0.jar  # OldCombatMechanics
      - https://www.curseforge.com/api/v1/mods/31620/files/6769644/download  # Dynmap
    
    # Dynmap 用のポート公開設定
    extraPorts:
      - name: dynmap
        containerPort: 8123
        protocol: TCP
        service:
          enabled: true
          type: ClusterIP
          port: 8123
        ingress:
          enabled: true
          ingressClassName: cloudflare
          hosts:
            - name: dynmap.youkan.uk
              path: /
  
  extraEnv:
    NETWORK_COMPRESSION_THRESHOLD: "-1"
    PLAYER_IDLE_TIMEOUT: "600"
    JVM_XX_OPTS: "-Djava.net.preferIPv4Stack=true"

  persistence:
    dataDir:
      enabled: true
      Size: 20Gi
      storageClassName: nfs-client
  
  resources:
    requests:
      memory: 4Gi
      cpu: 1000m
    limits:
      memory: 16Gi
      cpu: 4000m

  # ----------------------------------------------------
  # ConfigMap / Volume 設定エリア
  # ----------------------------------------------------

  # 1. ConfigMapの作成 (GitOps用)
  extraDeploy:
    - |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: minimotd-external-config
        namespace: {{ .Release.Namespace }}
        labels:
          app: {{ include "minecraft.fullname" . }}
      data:
        main.conf: |
          motd-enabled=true
          icon-enabled=false
          motds=[
              {
                  icon=""
                  line-1="<gradient:blue:aqua>✨ようかんの鯖✨</gradient>"
                  line-2="<gradient:aqua:blue>1.8.9 - 1.21 対応</gradient>"
              }
          ]
          player-count-settings {
              max-players-enabled=true
              max-players=20
              disable-player-list-hover=false
              hide-player-count=false
              fake-players { fake-players-enabled=false }
              just-x-more-settings { just-x-more-enabled=false }
              allow-exceeding-maximum=false
          }

  # 2. ボリュームの定義 (荷札)
  # ※ initContainersは削除し、標準のマウント機能を使います
  extraVolumes:
    # 設定ファイル (ConfigMap)
    - name: minimotd-config-vol
      configMap:
        name: minimotd-external-config
        defaultMode: 0644
    
    # ★重要: アイコンフォルダ用の一時領域 (書き込み可能にするため)
    - name: minimotd-icons-vol
      emptyDir: {}

  # 3. マウントの定義 (貼り付け場所)
  extraVolumeMounts:
    # 設定ファイルをピンポイントで配置 (subPath使用)
    # これにより、親フォルダ(/data/plugins/MiniMOTD)自体は書き込み可能なままになります
    - name: minimotd-config-vol
      mountPath: /data/plugins/MiniMOTD/main.conf
      subPath: main.conf
      readOnly: true
    
    # アイコンフォルダを書き込み可能領域としてマウント
    - name: minimotd-icons-vol
      mountPath: /data/plugins/MiniMOTD/icons

  # ヘルスチェック
  livenessProbe:
    command: ["mc-health"]
    initialDelaySeconds: 60
    periodSeconds: 10
    failureThreshold: 30
    timeoutSeconds: 5
    
  readinessProbe:
    command: ["mc-health"]
    initialDelaySeconds: 60
    periodSeconds: 10
    failureThreshold: 30
    timeoutSeconds: 5

  startupProbe:
    enabled: false